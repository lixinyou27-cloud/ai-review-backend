<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§‰å¯Ÿæ¸¸æˆ - æ¢ç´¢å†…åœ¨çš„æ™ºæ…§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: '#8B9D83',
                        earth: '#C19A6B',
                        ocean: '#4A90A4',
                        sunset: '#E07A5F',
                        forest: '#3D5A3C',
                        sand: '#F4E8D8'
                    },
                    fontFamily: {
                        serif: ['Noto Serif SC', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
        }

        .card-enter {
            animation: cardEnter 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .glow {
            box-shadow: 0 0 30px rgba(74, 144, 164, 0.3);
        }

        .card-gradient-sage {
            background: linear-gradient(135deg, #8B9D83 0%, #A8B99F 100%);
        }

        .card-gradient-ocean {
            background: linear-gradient(135deg, #4A90A4 0%, #6BAEC1 100%);
        }

        .card-gradient-sunset {
            background: linear-gradient(135deg, #E07A5F 0%, #EE9B84 100%);
        }

        .card-gradient-earth {
            background: linear-gradient(135deg, #C19A6B 0%, #D4B390 100%);
        }

        .card-gradient-forest {
            background: linear-gradient(135deg, #3D5A3C 0%, #5A7F58 100%);
        }

        .textarea-glow:focus {
            box-shadow: 0 0 20px rgba(74, 144, 164, 0.2);
        }

        .question-item {
            transition: all 0.3s ease;
        }

        .question-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>
<body class="font-sans min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-12 fade-in">
            <h1 class="text-4xl md:text-5xl font-serif font-bold text-gray-800 mb-3">
                è§‰å¯Ÿæ¸¸æˆ
            </h1>
            <p class="text-lg text-gray-600 font-light">
                é™ä¸‹å¿ƒæ¥ï¼Œå‘å†…æ¢ç´¢ï¼Œè®©æ™ºæ…§çš„å¡ç‰‡å¼•å¯¼ä½ æ€è€ƒäººç”Ÿ
            </p>
        </header>

        <div id="input-section" class="mb-12 fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-3 text-lg">
                        æ­¤åˆ»ï¼Œä½ æƒ³åˆ†äº«ä»€ä¹ˆï¼Ÿ
                    </label>
                    <textarea
                        id="user-input"
                        class="w-full h-40 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-ocean focus:outline-none transition-all resize-none textarea-glow"
                        placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•ã€æ„Ÿå—ã€å›°æƒ‘æˆ–ç»å†...&#10;&#10;å¯ä»¥æ˜¯ï¼š&#10;â€¢ ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆè®©ä½ å°è±¡æ·±åˆ»çš„äº‹&#10;â€¢ ä½ æ­£åœ¨æ€è€ƒçš„é—®é¢˜&#10;â€¢ å†…å¿ƒçš„æ„Ÿå—å’Œæƒ…ç»ª&#10;â€¢ å¯¹ç”Ÿæ´»çš„å›°æƒ‘"
                    ></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-3">
                        å½“å‰å¿ƒæƒ…ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-ocean hover:bg-ocean/10 transition-all" data-mood="å¹³é™">ğŸ§˜ å¹³é™</button>
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-sunset hover:bg-sunset/10 transition-all" data-mood="ç„¦è™‘">ğŸ˜° ç„¦è™‘</button>
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-sage hover:bg-sage/10 transition-all" data-mood="å›°æƒ‘">ğŸ¤” å›°æƒ‘</button>
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-earth hover:bg-earth/10 transition-all" data-mood="å–œæ‚¦">ğŸ˜Š å–œæ‚¦</button>
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-forest hover:bg-forest/10 transition-all" data-mood="æ‚²ä¼¤">ğŸ˜¢ æ‚²ä¼¤</button>
                        <button class="mood-tag px-4 py-2 rounded-full border-2 border-gray-200 hover:border-ocean hover:bg-ocean/10 transition-all" data-mood="æœŸå¾…">âœ¨ æœŸå¾…</button>
                    </div>
                </div>

                <button
                    id="generate-card-btn"
                    class="w-full bg-ocean hover:bg-ocean/90 text-white font-medium py-4 rounded-xl transition-all shadow-lg hover:shadow-xl hover:glow"
                >
                    ğŸ´ æŠ½å–è§‰å¯Ÿå¡ç‰‡
                </button>
            </div>
        </div>

        <div id="loading-section" class="hidden text-center py-12">
            <div class="inline-block">
                <div class="w-16 h-16 border-4 border-ocean/30 border-t-ocean rounded-full animate-spin mb-4"></div>
                <p class="text-gray-600 text-lg">æ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸“å±çš„è§‰å¯Ÿå¡ç‰‡...</p>
            </div>
        </div>

        <div id="card-section" class="hidden">
            <div id="awareness-card" class="card-enter bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div id="card-header" class="card-gradient-ocean text-white p-8">
                    <div class="flex items-center justify-between mb-2">
                        <span id="card-type" class="text-sm opacity-90 font-medium">åæ€å¡ç‰‡</span>
                        <button id="favorite-btn" class="text-2xl hover:scale-110 transition-transform">
                            <span id="favorite-icon">ğŸ¤</span>
                        </button>
                    </div>
                    <h2 id="card-title" class="text-3xl font-serif font-bold mb-2">å¡ç‰‡æ ‡é¢˜</h2>
                    <p id="card-time" class="text-sm opacity-80"></p>
                </div>

                <div class="p-8">
                    <div class="mb-8">
                        <h3 class="text-xl font-serif font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ’­</span> è§‰å¯Ÿæ´è§
                        </h3>
                        <div id="card-content" class="text-gray-700 leading-relaxed font-serif text-lg">
                        </div>
                    </div>

                    <div id="insights-section" class="mb-8 bg-sand/30 rounded-xl p-6">
                        <h3 class="text-xl font-serif font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">âœ¨</span> æ ¸å¿ƒæ´å¯Ÿ
                        </h3>
                        <p id="card-insights" class="text-gray-700 leading-relaxed font-serif"></p>
                    </div>

                    <div id="questions-section" class="mb-8">
                        <h3 class="text-xl font-serif font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ¤”</span> åæ€é—®é¢˜
                        </h3>
                        <ul id="card-questions" class="space-y-3">
                        </ul>
                    </div>

                    <div id="actions-section" class="mb-8">
                        <h3 class="text-xl font-serif font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ¯</span> å»ºè®®è¡ŒåŠ¨
                        </h3>
                        <p id="card-actions" class="text-gray-700 leading-relaxed"></p>
                    </div>

                    <div id="wisdom-section" class="border-l-4 border-ocean pl-6 py-2">
                        <p id="card-wisdom" class="text-gray-600 italic font-serif text-lg"></p>
                    </div>
                </div>

                <div class="border-t border-gray-100 p-6 bg-gray-50">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">
                            è¿™å¼ å¡ç‰‡ç»™ä½ å¸¦æ¥äº†ä»€ä¹ˆå¯å‘ï¼Ÿ
                        </label>
                        <textarea
                            id="reflection-input"
                            class="w-full h-24 px-4 py-3 border border-gray-300 rounded-lg focus:border-ocean focus:outline-none transition-all resize-none"
                            placeholder="è®°å½•ä½ çš„æ€è€ƒå’Œæ„Ÿæ‚Ÿ..."
                        ></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">
                            è¿™å¼ å¡ç‰‡å¯¹ä½ æœ‰å¤šå¤§å¸®åŠ©ï¼Ÿ
                        </label>
                        <div class="flex gap-2">
                            <button class="rating-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-ocean hover:text-white hover:border-ocean transition-all" data-rating="1">1â­</button>
                            <button class="rating-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-ocean hover:text-white hover:border-ocean transition-all" data-rating="2">2â­</button>
                            <button class="rating-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-ocean hover:text-white hover:border-ocean transition-all" data-rating="3">3â­</button>
                            <button class="rating-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-ocean hover:text-white hover:border-ocean transition-all" data-rating="4">4â­</button>
                            <button class="rating-btn px-4 py-2 border border-gray-300 rounded-lg hover:bg-ocean hover:text-white hover:border-ocean transition-all" data-rating="5">5â­</button>
                        </div>
                    </div>

                    <button id="save-reflection-btn" class="w-full bg-sage hover:bg-sage/90 text-white font-medium py-3 rounded-lg transition-all">
                        ä¿å­˜æˆ‘çš„æ€è€ƒ
                    </button>
                </div>

                <div class="p-6 border-t border-gray-100 flex gap-3">
                    <button id="new-card-btn" class="flex-1 bg-ocean hover:bg-ocean/90 text-white font-medium py-3 rounded-lg transition-all">
                        ğŸ´ å†æŠ½ä¸€å¼ 
                    </button>
                    <button id="view-history-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 rounded-lg transition-all">
                        ğŸ“š æŸ¥çœ‹å†å²
                    </button>
                </div>
            </div>
        </div>

        <div id="history-section" class="hidden mt-12">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-serif font-bold text-gray-800">ä½ çš„è§‰å¯Ÿå†ç¨‹</h2>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <div id="history-list" class="space-y-4">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const supabaseUrl = 'https://fyyjuwuwgxhwapyfvtpk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5eWp1d3V3Z3hod2FweWZ2dHBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Njk3NDUsImV4cCI6MjA3NzE0NTc0NX0.qqKGpKwVV8ddHqJ9C-bSKSV5yTz1vtrIzCmTDTb7rAY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentMood = null;
        let selectedRating = null;
        let currentCardId = null;
        let isFavorited = false;

        const moodTags = document.querySelectorAll('.mood-tag');
        moodTags.forEach(tag => {
            tag.addEventListener('click', () => {
                moodTags.forEach(t => t.classList.remove('bg-ocean', 'text-white', 'border-ocean'));
                tag.classList.add('bg-ocean', 'text-white', 'border-ocean');
                currentMood = tag.dataset.mood;
            });
        });

        const ratingBtns = document.querySelectorAll('.rating-btn');
        ratingBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                ratingBtns.forEach(b => {
                    b.classList.remove('bg-ocean', 'text-white', 'border-ocean');
                    b.classList.add('border-gray-300');
                });
                btn.classList.remove('border-gray-300');
                btn.classList.add('bg-ocean', 'text-white', 'border-ocean');
                selectedRating = parseInt(btn.dataset.rating);
            });
        });

        document.getElementById('generate-card-btn').addEventListener('click', generateCard);
        document.getElementById('new-card-btn').addEventListener('click', resetForNewCard);
        document.getElementById('save-reflection-btn').addEventListener('click', saveReflection);
        document.getElementById('view-history-btn').addEventListener('click', showHistory);
        document.getElementById('close-history-btn').addEventListener('click', () => {
            document.getElementById('history-section').classList.add('hidden');
        });
        document.getElementById('favorite-btn').addEventListener('click', toggleFavorite);

        async function generateCard() {
            const userInput = document.getElementById('user-input').value.trim();

            if (!userInput) {
                alert('è¯·è¾“å…¥ä¸€äº›å†…å®¹å†æŠ½å–å¡ç‰‡');
                return;
            }

            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');

            try {
                const { data: inputData, error: inputError } = await supabase
                    .from('awareness_inputs')
                    .insert([{ content: userInput, mood: currentMood }])
                    .select()
                    .maybeSingle();

                if (inputError) throw inputError;

                const card = await generateAwarenessCard(userInput, currentMood);

                const { data: cardData, error: cardError } = await supabase
                    .from('awareness_cards')
                    .insert([{
                        input_id: inputData.id,
                        card_type: card.type,
                        title: card.title,
                        content: card.content,
                        reflection_questions: card.questions,
                        insights: card.insights,
                        suggested_actions: card.actions,
                        wisdom_quote: card.wisdom,
                        color_theme: card.colorTheme
                    }])
                    .select()
                    .maybeSingle();

                if (cardError) throw cardError;

                currentCardId = cardData.id;
                isFavorited = false;
                displayCard(cardData);

            } catch (error) {
                console.error('Error:', error);
                alert('ç”Ÿæˆå¡ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('input-section').classList.remove('hidden');
            }
        }

        function generateAwarenessCard(userInput, mood) {
            const cardTypes = [
                { type: 'reflection', name: 'åæ€å¡ç‰‡', color: 'ocean' },
                { type: 'insight', name: 'æ´å¯Ÿå¡ç‰‡', color: 'sage' },
                { type: 'action', name: 'è¡ŒåŠ¨å¡ç‰‡', color: 'sunset' },
                { type: 'wisdom', name: 'æ™ºæ…§å¡ç‰‡', color: 'earth' },
                { type: 'compassion', name: 'æ…ˆæ‚²å¡ç‰‡', color: 'forest' }
            ];

            const randomCard = cardTypes[Math.floor(Math.random() * cardTypes.length)];

            const wisdomQuotes = [
                '"æ´»åœ¨å½“ä¸‹ï¼Œæ˜¯ä¸€åˆ‡æ™ºæ…§çš„å¼€å§‹ã€‚" â€” è€å­',
                '"è®¤è¯†è‡ªå·±ï¼Œæ˜¯æ‰€æœ‰æ™ºæ…§çš„èµ·ç‚¹ã€‚" â€” è‹æ ¼æ‹‰åº•',
                '"ç”Ÿå‘½ä¸åœ¨äºä½ å‘¼å¸äº†å¤šå°‘æ¬¡ï¼Œè€Œåœ¨äºæœ‰å¤šå°‘æ—¶åˆ»è®©ä½ æ— æ³•å‘¼å¸ã€‚"',
                '"å½“ä½ æ”¹å˜çœ‹å¾…äº‹ç‰©çš„æ–¹å¼æ—¶ï¼Œä½ æ‰€çœ‹å¾…çš„äº‹ç‰©ä¹Ÿä¼šæ”¹å˜ã€‚"',
                '"çœŸæ­£çš„æ—…ç¨‹ä¸åœ¨äºå¯»æ‰¾æ–°çš„é£æ™¯ï¼Œè€Œåœ¨äºæ‹¥æœ‰æ–°çš„çœ¼å…‰ã€‚"',
                '"ä¸æ˜¯äº‹ç‰©æœ¬èº«å›°æ‰°æˆ‘ä»¬ï¼Œè€Œæ˜¯æˆ‘ä»¬å¯¹äº‹ç‰©çš„çœ‹æ³•ã€‚" â€” çˆ±æ¯”å…‹æ³°å¾·',
                '"ç”Ÿæ´»å°±æ˜¯åœ¨æ­¤åˆ»å‘ç”Ÿçš„ï¼Œæ­¤æ—¶æ­¤åœ°ã€‚"'
            ];

            let content, insights, questions, actions, title;

            const contentLength = userInput.length;
            const hasDeepThinking = userInput.includes('ä¸ºä»€ä¹ˆ') || userInput.includes('å¦‚ä½•') || userInput.includes('å›°æƒ‘');

            if (randomCard.type === 'reflection') {
                title = 'åœä¸‹æ¥ï¼Œçœ‹è§è‡ªå·±';
                content = `ä½ åˆ†äº«çš„å†…å®¹è®©æˆ‘æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„å£°éŸ³ã€‚${mood ? `å¸¦ç€"${mood}"çš„å¿ƒæƒ…ï¼Œ` : ''}ä½ æ„¿æ„å‘å†…æ¢ç´¢ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€ç§å‹‡æ°”ã€‚\n\nç”Ÿæ´»ä¸­çš„æ¯ä¸€ä¸ªç¬é—´ï¼Œéƒ½æ˜¯è®¤è¯†è‡ªå·±çš„æœºä¼šã€‚å½“æˆ‘ä»¬åœä¸‹æ¥è§‚å¯Ÿè‡ªå·±çš„æƒ³æ³•å’Œæ„Ÿå—æ—¶ï¼Œæˆ‘ä»¬å°±å¼€å§‹äº†è§‰å¯Ÿçš„æ—…ç¨‹ã€‚`;
                insights = 'ä½ æ­£åœ¨ç»å†çš„ï¼Œæ— è®ºæ˜¯å–œæ‚¦è¿˜æ˜¯å›°æƒ‘ï¼Œéƒ½æ˜¯ä½ æˆé•¿çš„ä¸€éƒ¨åˆ†ã€‚æ¥çº³æ­¤åˆ»çš„è‡ªå·±ï¼Œå°±æ˜¯æœ€å¤§çš„æ™ºæ…§ã€‚';
                questions = [
                    'æ­¤åˆ»ï¼Œä½ çš„èº«ä½“æœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ',
                    'è¿™ä¸ªæƒ³æ³•/æ„Ÿå—æ˜¯ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿ',
                    'å¦‚æœæŠŠè¿™ä¸ªç»å†æ¯”ä½œä¸€æœ¬ä¹¦ï¼Œä½ ç°åœ¨åœ¨ç¬¬å‡ ç« ï¼Ÿ',
                    'ä¸€å¹´åå›çœ‹æ­¤åˆ»ï¼Œä½ å¸Œæœ›è‡ªå·±ä¼šæƒ³èµ·ä»€ä¹ˆï¼Ÿ'
                ];
                actions = 'ä»Šå¤©ç¡å‰ï¼Œç»™è‡ªå·±5åˆ†é’Ÿæ—¶é—´ï¼Œé—­ä¸Šçœ¼ç›ï¼Œæ·±å‘¼å¸ä¸‰æ¬¡ï¼Œé—®é—®è‡ªå·±ï¼š"æˆ‘ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"';
            } else if (randomCard.type === 'insight') {
                title = 'ä½ å·²ç»çŸ¥é“ç­”æ¡ˆ';
                content = `åœ¨ä½ çš„æ–‡å­—ä¸­ï¼Œæˆ‘çœ‹åˆ°äº†æ¢ç´¢å’Œæ€è€ƒã€‚${mood ? `"${mood}"è¿™ç§æ„Ÿå—ï¼Œ` : 'ä½ çš„æƒ³æ³•ï¼Œ'}æ­£åœ¨å‘Šè¯‰ä½ ä¸€äº›é‡è¦çš„ä¿¡æ¯ã€‚\n\næœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰ç­”æ¡ˆï¼Œåªæ˜¯è¿˜æ²¡æœ‰å‡†å¤‡å¥½æ¥å—å®ƒã€‚ç»™è‡ªå·±ä¸€äº›æ—¶é—´å’Œç©ºé—´ï¼Œç­”æ¡ˆä¼šåœ¨æ°å½“çš„æ—¶åˆ»å‡ºç°ã€‚`;
                insights = 'ä½ å†…å¿ƒæ·±å¤„å·²ç»çŸ¥é“ä»€ä¹ˆå¯¹ä½ æ˜¯é‡è¦çš„ã€‚ç›¸ä¿¡ä½ çš„ç›´è§‰ï¼Œå®ƒå¾€å¾€æ¯”å¤§è„‘æ›´æ—©çŸ¥é“çœŸç›¸ã€‚';
                questions = [
                    'å¦‚æœæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œä½ æœ€æƒ³åšä»€ä¹ˆï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™ä½ æ„Ÿåˆ°æœ€çœŸå®çš„è‡ªå·±ï¼Ÿ',
                    'ä½ çš„å†…å¿ƒæ·±å¤„ï¼Œæœ€æ¸´æœ›ä»€ä¹ˆï¼Ÿ',
                    'å¦‚æœä½ çš„æ™ºæ…§è€äººä¼šå¯¹ç°åœ¨çš„ä½ è¯´ä»€ä¹ˆï¼Ÿ'
                ];
                actions = 'å†™ä¸‹ä¸‰ä»¶è®©ä½ æ„Ÿåˆ°å……å®å’Œæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œè§‚å¯Ÿå®ƒä»¬ä¹‹é—´çš„è”ç³»ã€‚';
            } else if (randomCard.type === 'action') {
                title = 'å¾®å°çš„è¡ŒåŠ¨ï¼Œå·¨å¤§çš„æ”¹å˜';
                content = `ä½ çš„è§‰å¯Ÿå·²ç»æ˜¯æ”¹å˜çš„å¼€å§‹ã€‚${mood ? `å³ä½¿åœ¨"${mood}"çš„çŠ¶æ€ä¸‹ï¼Œ` : ''}ä½ ä»ç„¶é€‰æ‹©äº†æ€è€ƒå’Œè¡¨è¾¾ï¼Œè¿™éœ€è¦å‹‡æ°”ã€‚\n\næ”¹å˜ä¸éœ€è¦ç­‰åˆ°å‡†å¤‡å¥½çš„é‚£ä¸€å¤©ï¼Œä»ä¸€ä¸ªå°å°çš„è¡ŒåŠ¨å¼€å§‹ï¼Œå°±æ˜¯æœ€å¥½çš„æ—¶æœºã€‚`;
                insights = 'è¡ŒåŠ¨æ˜¯è¿æ¥ç°åœ¨å’Œæœªæ¥çš„æ¡¥æ¢ã€‚ä¸å¿…ç­‰åˆ°å®Œç¾çš„è®¡åˆ’ï¼Œä¸€ä¸ªå°æ­¥éª¤å°±è¶³ä»¥å¼€å¯æ–°çš„å¯èƒ½ã€‚';
                questions = [
                    'æ­¤åˆ»ï¼Œå“ªæ€•åªæœ‰1%çš„æ”¹å–„ï¼Œä½ å¯ä»¥åšä»€ä¹ˆï¼Ÿ',
                    'ä»€ä¹ˆæ˜¯ä½ ä¸€ç›´æƒ³åšä½†è¿˜æ²¡å¼€å§‹çš„äº‹ï¼Ÿ',
                    'å¦‚æœä»Šå¤©å°±æ˜¯æ–°å¼€å§‹çš„ç¬¬ä¸€å¤©ï¼Œä½ ä¼šåšä»€ä¹ˆä¸åŒçš„é€‰æ‹©ï¼Ÿ',
                    'ä¸‰ä¸ªæœˆåï¼Œä½ å¸Œæœ›è‡ªå·±å·²ç»åšäº†ä»€ä¹ˆï¼Ÿ'
                ];
                actions = 'é€‰æ‹©ä¸€ä¸ªå¯ä»¥åœ¨10åˆ†é’Ÿå†…å®Œæˆçš„å°è¡ŒåŠ¨ï¼Œç°åœ¨å°±å»åšã€‚ä¸è¦æ€è€ƒå¤ªå¤šï¼Œå¼€å§‹å°±æ˜¯èƒœåˆ©ã€‚';
            } else if (randomCard.type === 'wisdom') {
                title = 'åœ¨ç»å†ä¸­æˆé•¿';
                content = `ç”Ÿå‘½å°±æ˜¯ä¸€åœºä½“éªŒçš„æ—…ç¨‹ã€‚ä½ ç°åœ¨æ­£åœ¨ç»å†çš„ï¼Œ${mood ? `è¿™ä»½"${mood}"ï¼Œ` : ''}éƒ½æ˜¯ä½ ç‹¬ç‰¹äººç”Ÿæ•…äº‹çš„ä¸€éƒ¨åˆ†ã€‚\n\næ¯ä¸ªç»å†éƒ½åœ¨æ•™å¯¼æˆ‘ä»¬æŸäº›ä¸œè¥¿ï¼Œæœ‰æ—¶å€™è¯¾ç¨‹è¦åœ¨äº‹åæ‰èƒ½çœ‹æ¸…ã€‚ç»™è‡ªå·±è€å¿ƒï¼Œç»™ç”Ÿå‘½æ—¶é—´ã€‚`;
                insights = 'æ™ºæ…§ä¸æ˜¯é¿å…çŠ¯é”™ï¼Œè€Œæ˜¯åœ¨é”™è¯¯ä¸­å­¦ä¹ ã€‚ä¸æ˜¯æ¶ˆé™¤ç—›è‹¦ï¼Œè€Œæ˜¯åœ¨ç—›è‹¦ä¸­æ‰¾åˆ°æ„ä¹‰ã€‚';
                questions = [
                    'è¿™ä¸ªç»å†æƒ³è¦æ•™ä¼šä½ ä»€ä¹ˆï¼Ÿ',
                    'äº”å¹´åçš„ä½ ï¼Œä¼šå¦‚ä½•çœ‹å¾…ç°åœ¨çš„è‡ªå·±ï¼Ÿ',
                    'ä½ ä»è¿™ä¸ªç»å†ä¸­ï¼Œå·²ç»å˜å¾—ä¸åŒäº†å—ï¼Ÿ',
                    'å¦‚æœè¦æ„Ÿè°¢è¿™ä¸ªç»å†ï¼Œä½ ä¼šæ„Ÿè°¢å®ƒä»€ä¹ˆï¼Ÿ'
                ];
                actions = 'æ‰¾ä¸€ä¸ªå®‰é™çš„åœ°æ–¹ï¼Œå†™ä¸‹"æˆ‘æ­£åœ¨å­¦ä¹ ___"ï¼Œè®©ç­”æ¡ˆè‡ªç„¶æµ®ç°ã€‚';
            } else {
                title = 'æ¸©æŸ”åœ°å¯¹å¾…è‡ªå·±';
                content = `çœ‹åˆ°ä½ çš„æ–‡å­—ï¼Œæˆ‘æ„Ÿå—åˆ°ä½ å¯¹è‡ªå·±å’Œç”Ÿæ´»çš„å…³æ³¨ã€‚${mood ? `å¸¦ç€"${mood}"çš„å¿ƒæƒ…ï¼Œ` : ''}ä½ é€‰æ‹©äº†è¡¨è¾¾å’Œè§‰å¯Ÿï¼Œè¿™æœ¬èº«å°±å€¼å¾—è‚¯å®šã€‚\n\næˆ‘ä»¬å¸¸å¸¸å¯¹åˆ«äººæ¯”å¯¹è‡ªå·±æ›´æ¸©æŸ”ã€‚ä»Šå¤©ï¼Œè¯•ç€ç”¨å¯¹å¾…å¥½æœ‹å‹çš„æ–¹å¼ï¼Œå¯¹å¾…è‡ªå·±ã€‚`;
                insights = 'è‡ªæˆ‘æ…ˆæ‚²ä¸æ˜¯è½¯å¼±ï¼Œè€Œæ˜¯åŠ›é‡ã€‚å½“ä½ å¯¹è‡ªå·±æ¸©æŸ”æ—¶ï¼Œä½ æ‰æœ‰èƒ½é‡å»é¢å¯¹ç”Ÿæ´»çš„æŒ‘æˆ˜ã€‚';
                questions = [
                    'å¦‚æœä½ æœ€å¥½çš„æœ‹å‹é‡åˆ°åŒæ ·çš„æƒ…å†µï¼Œä½ ä¼šå¯¹TAè¯´ä»€ä¹ˆï¼Ÿ',
                    'æ­¤åˆ»ï¼Œä½ çš„å†…å¿ƒå°å­©éœ€è¦ä»€ä¹ˆï¼Ÿ',
                    'ä½ å·²ç»åšå¾—å¾ˆå¥½çš„åœ°æ–¹æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'ä»Šå¤©ï¼Œä½ å¯ä»¥å¦‚ä½•å–„å¾…è‡ªå·±ï¼Ÿ'
                ];
                actions = 'å¯¹ç€é•œå­ï¼Œçœ‹ç€è‡ªå·±çš„çœ¼ç›ï¼Œè¯´ä¸‰éï¼š"æˆ‘æ¥çº³ç°åœ¨çš„è‡ªå·±ã€‚"';
            }

            return {
                type: randomCard.name,
                title: title,
                content: content,
                insights: insights,
                questions: questions,
                actions: actions,
                wisdom: wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)],
                colorTheme: randomCard.color
            };
        }

        function displayCard(cardData) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('card-section').classList.remove('hidden');

            const cardHeader = document.getElementById('card-header');
            cardHeader.className = `card-gradient-${cardData.color_theme} text-white p-8`;

            document.getElementById('card-type').textContent = cardData.card_type;
            document.getElementById('card-title').textContent = cardData.title;
            document.getElementById('card-time').textContent = new Date(cardData.created_at).toLocaleString('zh-CN');
            document.getElementById('card-content').textContent = cardData.content;
            document.getElementById('card-insights').textContent = cardData.insights;
            document.getElementById('card-actions').textContent = cardData.suggested_actions;
            document.getElementById('card-wisdom').textContent = cardData.wisdom_quote;

            const questionsList = document.getElementById('card-questions');
            questionsList.innerHTML = '';
            cardData.reflection_questions.forEach(q => {
                const li = document.createElement('li');
                li.className = 'question-item flex items-start text-gray-700 leading-relaxed';
                li.innerHTML = `<span class="mr-2 text-ocean">â€¢</span><span>${q}</span>`;
                questionsList.appendChild(li);
            });

            updateFavoriteIcon();

            document.getElementById('reflection-input').value = '';
            selectedRating = null;
            ratingBtns.forEach(b => {
                b.classList.remove('bg-ocean', 'text-white', 'border-ocean');
                b.classList.add('border-gray-300');
            });

            window.scrollTo({ top: document.getElementById('card-section').offsetTop - 20, behavior: 'smooth' });
        }

        async function toggleFavorite() {
            if (!currentCardId) return;

            isFavorited = !isFavorited;

            const { error } = await supabase
                .from('awareness_cards')
                .update({ is_favorited: isFavorited })
                .eq('id', currentCardId);

            if (!error) {
                updateFavoriteIcon();
            }
        }

        function updateFavoriteIcon() {
            document.getElementById('favorite-icon').textContent = isFavorited ? 'â¤ï¸' : 'ğŸ¤';
        }

        async function saveReflection() {
            const reflectionText = document.getElementById('reflection-input').value.trim();

            if (!reflectionText && !selectedRating) {
                alert('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹å†…å®¹');
                return;
            }

            if (!currentCardId) return;

            try {
                const { error } = await supabase
                    .from('card_reflections')
                    .insert([{
                        card_id: currentCardId,
                        reflection_text: reflectionText || '',
                        helpful_rating: selectedRating
                    }]);

                if (error) throw error;

                alert('ä½ çš„æ€è€ƒå·²ä¿å­˜ï¼');
                document.getElementById('reflection-input').value = '';
                selectedRating = null;
                ratingBtns.forEach(b => {
                    b.classList.remove('bg-ocean', 'text-white', 'border-ocean');
                    b.classList.add('border-gray-300');
                });

            } catch (error) {
                console.error('Error:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function resetForNewCard() {
            document.getElementById('card-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('user-input').value = '';
            currentMood = null;
            moodTags.forEach(t => t.classList.remove('bg-ocean', 'text-white', 'border-ocean'));
            currentCardId = null;
            isFavorited = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function showHistory() {
            const { data: cards, error } = await supabase
                .from('awareness_cards')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) {
                console.error('Error:', error);
                return;
            }

            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            if (cards.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-8">è¿˜æ²¡æœ‰å†å²å¡ç‰‡</p>';
            } else {
                cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-sm text-gray-500">${card.card_type}</span>
                                <h3 class="font-serif font-semibold text-lg text-gray-800">${card.title}</h3>
                            </div>
                            ${card.is_favorited ? '<span class="text-xl">â¤ï¸</span>' : ''}
                        </div>
                        <p class="text-gray-600 text-sm line-clamp-2 mb-2">${card.content}</p>
                        <p class="text-xs text-gray-400">${new Date(card.created_at).toLocaleString('zh-CN')}</p>
                    `;
                    div.addEventListener('click', () => {
                        currentCardId = card.id;
                        isFavorited = card.is_favorited;
                        displayCard(card);
                        document.getElementById('history-section').classList.add('hidden');
                    });
                    historyList.appendChild(div);
                });
            }

            document.getElementById('history-section').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('history-section').offsetTop - 20, behavior: 'smooth' });
        }
    </script>
</body>
</html>
